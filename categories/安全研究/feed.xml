<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>安全研究 on Zer0d0y(段公子)&#39;s Blog</title>
    <link>https://www.zer0d0y.info/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/feed/index.xml</link>
    <description>Recent content in 安全研究 on Zer0d0y(段公子)&#39;s Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <copyright>Copyright (c) 2017. All rights reserved.</copyright>
    <atom:link href="https://www.zer0d0y.info/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/feed/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Pentesting iOS Applications Part 1 - Intercepting HTTP(S) Traffic with Burp Suite</title>
      <link>https://www.zer0d0y.info/post/Pentesting-iOS-Applications-Part-1/</link>
      <pubDate>Sun, 19 Feb 2017 14:50:02 +0800</pubDate>
      
      <guid>https://www.zer0d0y.info/post/Pentesting-iOS-Applications-Part-1/</guid>
      <description>

&lt;h4 id=&#34;tl-dr-深度探索ios-app流量分析方法&#34;&gt;&lt;strong&gt;TL;DR -&lt;/strong&gt; 深度探索iOS App流量分析方法&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;ENV（环境）：&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;OS：Deiban 8.x&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;iOS：10.x&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Broswer：Chrome 56.x/Safari 10&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Burp Suite Pro：v1.7.x&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;App：咕咚运动&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;!--- **Intercepting HTTP(S) Traffic：**

&gt; - Burp 配置
&gt; - ①.PC和iOS设备连接到同一局域网
&gt; - ②.配置Burp监听0.0.0.0:8080，勾选Running复选框

&gt; - iOS设备配置：
&gt; - ③.设置 - Wi-Fi - &#34;SSID&#34; - 点击i - HTTP PROXY - Manual，填写运行Burp的PC的IP地址和端口
&gt; - ④.浏览器里打开http://burp -- 点击CA Certificate -- 安装证书
&gt; - ⑤.测试：浏览器里打开http://www.google.com，https://www.google.com
--&gt;

&lt;dl&gt;
&lt;dt&gt;Intercepting HTTP(S) Traffic：&lt;/dt&gt;
&lt;dd&gt;&lt;p&gt;Burp 配置：&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;①.PC和iOS设备连接到同一局域网，启动Burp：cd /Path/to/burpsuite_pro &amp;amp;&amp;amp; java -jar -Xmx2G burpsuite_pro.jar&lt;/p&gt;

&lt;p&gt;②.配置Burp监听0.0.0.0:8080，勾选Running复选框&lt;/p&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;iOS设备配置：&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;③.设置 - Wi-Fi - &amp;ldquo;SSID&amp;rdquo; - 点击i - HTTP PROXY - Manual，填写运行Burp的PC的IP地址和端口&lt;/p&gt;

&lt;p&gt;④.浏览器里打开&lt;a href=&#34;http://burp&#34;&gt;http://burp&lt;/a&gt; &amp;mdash;&amp;gt; 点击CA Certificate &amp;mdash;&amp;gt; 安装证书（测试完成后删除证书）&lt;/p&gt;

&lt;p&gt;⑤.测试：浏览器(Safari)里分别打开&lt;a href=&#34;http://z.cn&#34;&gt;http://z.cn&lt;/a&gt; 和 &lt;a href=&#34;https://www.google.com&#34;&gt;https://www.google.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;/dl&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/Pentesting-iOS-Applications/P1001.jpg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;&lt;strong&gt;Bypassing SSL endpoint verification with stunnel：&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;①.modifying a plist file containing the endpoint URL.&lt;/li&gt;

&lt;li&gt;&lt;p&gt;②.配置Stunnel使用Client模式，Stunnel配置文件示例如下：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;; SSL client mode
client = yes
; service-level configuration   
[https]   
accept = 127.0.0.1:80   
connect = TargetIP:443   
TIMEOUTclose = 0   
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;③.配置Burp使用&lt;a href=&#34;https://portswigger.net/burp/help/proxy_options_invisible.html&#34;&gt;invisible proxying&lt;/a&gt;并将请求重定向到Stunnel&lt;br /&gt;
Burp &amp;mdash;&amp;gt; Proxy &amp;mdash;&amp;gt; Options &amp;mdash;&amp;gt; Edit(0.0.0.0:8080) &amp;mdash;&amp;gt; Request Handling(IP:127.0.0.1 Port:80)，勾选Support invisible proxying&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/Pentesting-iOS-Applications/P1002.jpg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;dl&gt;
&lt;dt&gt;&lt;strong&gt;iOS networking&lt;/strong&gt;&lt;/dt&gt;
&lt;dd&gt;&lt;p&gt;iOS network API:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;①.the URL loading system(NSURLConnection or NSURLSession)&lt;br /&gt;
②.the Foundation NSStream API&lt;br /&gt;
③.the Core Foundation CFStream API.&lt;br /&gt;
&lt;strong&gt;NSStream和CFStream(Lower-Level Networking)&lt;/strong&gt;用于处理非HTTP类型连接的数据，参考：&lt;a href=&#34;https://github.com/iSECPartners/tcpprox/&#34;&gt;https://github.com/iSECPartners/tcpprox/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;/dl&gt;

&lt;p&gt;&lt;strong&gt;Spotting NSURLSession TLS Bypasses&lt;/strong&gt;&lt;br /&gt;
NSURLSession has a way to avoid TLS checks as well. Apps can just use the didReceiveChallenge delegate and pass the proposedCredential of the challenge received back as a credential for the session,&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;- (void)URLSession:(NSURLSession *)session didReceiveChallenge:(NS
   URLAuthenticationChallenge *)challenge completionHandler:(void (^)(NS
   URLSessionAuthChallengeDisposition disposition, NSURLCredential * credential))
   completionHandler {
   completionHandler(NSURLSessionAuthChallengeUseCredential,
    [challenge proposedCredential]);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;相关技术-中间人-攻击-和端口镜像-network-tap&#34;&gt;相关技术（中间人“攻击”和端口镜像/Network Tap）&lt;/h5&gt;

&lt;p&gt;A.中间人“攻击”，&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Linux 服务器（网关）配置：
1.echo 1 &amp;gt; /proc/sys/net/ipv4/ip_forward
2.iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080
3.iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 8080
4.Burp Suite 监听 *:8080，勾选Invisible

iOS设备配置：
网关设置为Linux 服务器IP地址
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;B.端口镜像/Network Tap，&lt;br /&gt;
参考：&lt;br /&gt;
&lt;a href=&#34;https://en.wikipedia.org/wiki/Port_mirroring&#34;&gt;端口镜像&lt;/a&gt;/&lt;a href=&#34;https://en.wikipedia.org/wiki/Network_tap&#34;&gt;Network Tap&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Bro &#43; ELK</title>
      <link>https://www.zer0d0y.info/post/Bro-plus-ELK/</link>
      <pubDate>Thu, 13 Aug 2015 10:14:11 +0800</pubDate>
      
      <guid>https://www.zer0d0y.info/post/Bro-plus-ELK/</guid>
      <description>


&lt;figure &gt;
    
        &lt;img src=&#34;images/Bro-ELK/Bro_ELK01.jpg&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;table class=&#34;image&#34;&gt;
&lt;caption align=&#34;bottom&#34;&gt; &#34;The Bro Network Security Monitor &amp; ELK Stack&#34; &lt;/caption&gt;
&lt;/table&gt;

&lt;pre&gt;&lt;code&gt;TL;DR - No Security without Visibility | 部署Bro进行网络安全监控、分析，入侵检测，使用ELK Stack分析Bro收集的日志。
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;关于-bro-https-www-bro-org-index-html-the-bro-network-security-monitor&#34;&gt;关于&lt;a href=&#34;https://www.bro.org/index.html&#34;&gt;Bro&lt;/a&gt;(The Bro Network Security Monitor)&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;Bro is an open-source network security platform that illuminates your network&#39;s activity in detail, with the stability and flexibility for production deployment at scale.
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;1-bro-安装-基本配置&#34;&gt;1.（Bro）安装&amp;amp;基本配置&lt;/h4&gt;

&lt;dl&gt;
&lt;dd&gt;&lt;p&gt;1.）网络环境及软件环境&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;网络环境：网络边界上部署Network Tap或使用交换机端口镜像功能（Port Mirroring）将In和Out双向流量copy到Bro Cluster --&amp;gt; https://www.bro.org/sphinx/cluster/index.html。
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;软件环境：OS：Ubuntu 14.04 LTS，Bro：2.4.x，ELK：Elasticsearch-1.7.x | Logstash-1.5.x | kibana-4.1.1
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;2.）添加签名Key&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;wget http://download.opensuse.org/repositories/network:bro/xUbuntu_14.04/Release.key
apt-key add - &amp;lt; Release.key
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;3.）添加Repository&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;echo &#39;deb http://download.opensuse.org/repositories/network:/bro/xUbuntu_14.04/ /&#39; &amp;gt;&amp;gt; /etc/apt/sources.list.d/bro.list
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;4.）安装&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;apt-get update
apt-get install bro
echo &amp;quot;export PATH=/opt/bro/bin:$PATH&amp;quot; &amp;gt;&amp;gt; ~/.bashrc
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;5.）定制Bro配置文件，然后初始化&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;配置监听网络接口：/opt/bro/etc/node.cfg
配置本地网络地址：/opt/bro/etc/networks.cfg
主配置文件：/opt/bro/etc/broctl.cfg
初始化：broctl deploy
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;6.）添加计划任务（监控Bro集群节点状态和日志轮询）&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;0-59/5 * * * * /opt/bro/bin/broctl cron
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;7.）修改默认监听端口&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;/opt/bro/etc/broctl.cfg
BroPort =  10000 
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;8.）加载定制脚本&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;下载：wget &lt;a href=&#34;https://github.com/jonschipp/bro-scripts/blob/master/dns-audit.bro&#34;&gt;https://github.com/jonschipp/bro-scripts/blob/master/dns-audit.bro&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;编辑配置文件：vi /opt/bro/share/bro/site/local.bro&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@load dns-audit.bro   
cp dns-audit.bro /opt/bro/share/bro/site/   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;执行：broctl deploy&lt;/p&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;9.）电子邮件报警（ssmtp + TX exmail）&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Bro主配置文件&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /opt/bro/etc/broctl.cfg
MailTo = Zer0d0y@Zer0d0y.info
SendMail = /usr/sbin/sendmail 
MailFrom = bro-nsm@Zer0d0y.info
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ssmtp配置&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/ssmtp/ssmtp.conf
root=bro-nsm@Zer0d0y.info
mailhub=smtp.exmail.qq.com:465
hostname=bro-nsm
UseTLS=Yes
AuthUser=bro-nsm@Zer0d0y.info
AuthPass=[电子邮件密码]
FromLineOverride=yes
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ssmtp别名&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vi /etc/ssmtp/revaliases 
root:bro-nsm@Zer0d0y.info:smtp.exmail.qq.com:465
mainuser:bro-nsm@Zer0d0y.info:smtp.exmail.qq.com:465
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;/dl&gt;

&lt;h4 id=&#34;2-elk-安装-基本配置&#34;&gt;2.（ELK）安装&amp;amp;基本配置&lt;/h4&gt;

&lt;dl&gt;
&lt;dd&gt;&lt;p&gt;1.）安装JAVA&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;add-apt-repository -y ppa:webupd8team/java
apt-get update
apt-get -y install oracle-java8-installer
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;2.）安装Elasticsearch&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;#添加Key：
wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | apt-key add -
#添加Repository：
echo &amp;quot;deb https://packages.elastic.co/elasticsearch/1.7/debian stable main&amp;quot; |  tee -a /etc/apt/sources.list.d/elasticsearch-1.7.list
#安装：
apt-get update &amp;amp;&amp;amp;  apt-get -y install elasticsearch
#配置：
vi /etc/elasticsearch/elasticsearch.yml
network.host: localhost
#启动服务：
service elasticsearch restart
#设置默认启动：
update-rc.d elasticsearch defaults 95 10
#测试：
curl -X GET http://localhost:9200/
#参考：
https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-repositories.html
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;3.）安装Logstash&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;#添加Repository：
echo &#39;deb https://packages.elasticsearch.org/logstash/1.5/debian stable main&#39; |  tee /etc/apt/sources.list.d/logstash.list
#安装：
apt-get update &amp;amp;&amp;amp;  apt-get -y install Logstash
# Change logstash gem sources
/opt/logstash/vendor/bundle/jruby/1.9/gems/gems-0.8.3/lib/gems/configuration.rb
/opt/logstash/vendor/jruby/lib/ruby/shared/rubygems/defaults.rb
/opt/logstash/Gemfile
Replace rubygems.org ==&amp;gt; ruby.taobao.org
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;4.）安装Kibana&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;#创建并进入临时目录
mkdir ~/tmp ; cd ～/tmp
#下载kibana并check sha1sum
wget https://download.elastic.co/kibana/kibana/kibana-4.1.1-linux-x64.tar.gz
wget https://download.elastic.co/kibana/kibana/kibana-4.1.1-linux-x64.tar.gz.sha1.txt
#解压&amp;amp;配置
tar xf kibana-*.tar.gz
vi ~/tmp/kibana-4*/config/kibana.yml
host: &amp;quot;localhost&amp;quot;
mkdir -p /opt/kibana
cp -R ~/tmp/kibana-4*/* /opt/kibana/
#启动配置脚本
cd /etc/init.d &amp;amp;&amp;amp;  wget https://gist.githubusercontent.com/thisismitch/8b15ac909aed214ad04a/raw/bce61d85643c2dcdfbc2728c55a41dab444dca20/kibana4
chmod +x /etc/init.d/kibana4
update-rc.d kibana4 defaults 96 9
service kibana4 start
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;dd&gt;&lt;p&gt;5.）配置Kibana HTTP认证&lt;/p&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code&gt;#安装Nginx和apache2-utils
apt-get install nginx apache2-utils
#设置用户名（Zer0d0y）和密码
htpasswd -c /etc/nginx/htpasswd.users Zer0d0y
#修改Nginx配置文件
vi /etc/nginx/conf.d/kibana.conf
server {
    listen 80;

    server_name nsm.Zer0d0y.info;

    auth_basic &amp;quot;Restricted Access&amp;quot;;
    auth_basic_user_file /etc/nginx/htpasswd.users;

    location / {
        proxy_pass http://localhost:5601;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &#39;upgrade&#39;;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;        
    }
}
#重启Nginx服务是配置生效
service nginx restart
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;&lt;/dd&gt;
&lt;/dl&gt;

&lt;h4 id=&#34;3-配置logstash处理bro日志文件&#34;&gt;3.配置Logstash处理Bro日志文件&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;#下载Logstash配置文件
cd /etc/logstash/conf.d/
wget https://github.com/Zer0d0y/Bro-ELK/tree/master/logstash
#修改Bro 日志文件权限：
chmod o+rx /opt/bro/logs
chmod o+rx /opt/bro/spool
#测试：
sudo -u logstash /opt/logstash/bin/logstash agent -f /etc/logstash/conf.d --configtest
curl &amp;quot;http://localhost:9200/_search?size=5&amp;amp;pretty=true&amp;quot;
curl &amp;quot;http://localhost:9200/_search?q=type:logs&amp;amp;pretty=true&amp;quot;
#重启Logstash：
sudo /etc/init.d/logstash restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;效果图（右键放大图片）&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;images/Bro-ELK/Bro_ELK02.png&#34; /&gt;
    
    
&lt;/figure&gt;



&lt;figure &gt;
    
        &lt;img src=&#34;images/Bro-ELK/Bro_ELK03.png&#34; /&gt;
    
    
&lt;/figure&gt;



&lt;figure &gt;
    
        &lt;img src=&#34;images/Bro-ELK/Bro_ELK04.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;h4 id=&#34;4-配置文件下载地址&#34;&gt;4.配置文件下载地址：&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;https://github.com/Zer0d0y/Bro-ELK
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;5-todo-ref&#34;&gt;5.ToDO &amp;amp; Ref&lt;/h4&gt;

&lt;p&gt;1.）ToDO&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;高级主题
Bro Scripts（https://www.bro.org/sphinx/scripting/index.html）
Bro Intel Framework（https://intel.criticalstack.com/）
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.）Ref（参考）&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;https://www.bro.org/why_choose_bro.pdf
https://bro-tracker.atlassian.net/secure/Dashboard.jspa
https://www.bro.org/documentation/index.html
https://www.bro.org/sphinx/scripts/base/protocols/conn/main.bro.html
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>